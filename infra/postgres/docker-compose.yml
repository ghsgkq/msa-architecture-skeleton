version: '3.8'

services:
  # 1. PostgreSQL 데이터베이스 서비스
  postgres:
    image: postgres:16-alpine # 가벼운 Alpine 버전 사용 (필요시 버전 변경)
    container_name: postgres_test_db
    restart: always
    environment:
      POSTGRES_USER: skeleton       # DB 접속 유저명
      POSTGRES_PASSWORD: msa123!@ # DB 접속 비밀번호
      POSTGRES_DB: my-test         # 기본 생성될 DB 이름
      TZ: Asia/Seoul              # 타임존 설정
    ports:
      - "7432:5432"               # 호스트 포트 : 컨테이너 포트
    volumes:
      - postgres_data:/var/lib/postgresql/data # 데이터 영구 저장 (컨테이너 내려도 데이터 유지)
      - ./init-sql:/docker-entrypoint-initdb.d # 초기화 SQL 스크립트 폴더 마운트
    networks:
      - postgres-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U skeleton -d msa123!@"]
      interval: 5s
      timeout: 5s
      retries: 5

  # 2. PgAdmin4 (웹 기반 DB 관리 도구 - 선택 사항)
  pgadmin:
    image: dpage/pgadmin4
    container_name: pgadmin_test_ui
    restart: always
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@admin.com # 웹 로그인 이메일
      PGADMIN_DEFAULT_PASSWORD: admin        # 웹 로그인 비밀번호
    ports:
      - "7050:80" # 브라우저에서 localhost:5050 으로 접속
    depends_on:
      postgres:
        condition: service_healthy # DB가 완전히 뜬 후에 실행
    networks:
      - postgres-net

volumes:
  postgres_data: # 도커 볼륨 생성

networks:
  postgres-net:
    driver: bridge